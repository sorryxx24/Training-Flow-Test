<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>臺北市政府消防局 114年教育訓練管理系統 (最終修正版)</title>
    <style>
        :root {
            --primary-color: #1e40af;
            --secondary-color: #1e293b;
            --bg-color: #f3f4f6;
            --border-color: #cbd5e1;
            --text-main: #0f172a;
            --header-bg: #f1f5f9;
        }

        body {
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
            color: var(--text-main);
        }

        /* 側邊欄 */
        .sidebar {
            width: 220px;
            background-color: var(--secondary-color);
            color: white;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }
        .sidebar-header { padding: 20px; border-bottom: 1px solid #334155; background: #0f172a; }
        .sidebar-header h2 { margin: 0; font-size: 16px; font-weight: bold; letter-spacing: 1px; }
        .nav-item { padding: 15px 20px; cursor: pointer; border-left: 4px solid transparent; color: #94a3b8; font-size: 14px; display: flex; align-items: center; gap: 8px; transition: 0.2s; }
        .nav-item:hover { background-color: #334155; color: white; }
        .nav-item.active { background-color: #334155; color: #60a5fa; border-left-color: #60a5fa; font-weight: bold; }

        /* 主內容區 */
        .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .top-bar { height: 50px; background: white; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; }
        .workspace { flex: 1; padding: 15px; overflow: hidden; display: flex; flex-direction: column; }
        
        .view-section { display: none; height: 100%; flex-direction: column; background: white; border: 1px solid var(--border-color); border-radius: 4px; overflow: hidden; }
        .view-section.active { display: flex; }
        
        .table-container { flex: 1; overflow: auto; }

        /* --- 表格核心樣式 (仿 Excel) --- */
        table { border-collapse: collapse; font-size: 13px; table-layout: fixed; width: 100%; }
        
        /* 強制欄位寬度 */
        #table1 { min-width: 1900px; }
        #table2 { min-width: 1700px; }
        #table3 { min-width: 1300px; }
        #table4 { min-width: 1400px; }

        th {
            background-color: var(--header-bg);
            color: #334155;
            font-weight: 700;
            border: 1px solid #94a3b8; /* 深色邊框 */
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 10;
            height: 45px;
            padding: 2px;
            vertical-align: middle;
        }

        /* 修復表頭跑版問題：使用 Flexbox 強制置中 */
        .th-content {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            width: 100%;
            line-height: 1.3;
            white-space: normal; /* 允許換行 */
        }

        td {
            border: 1px solid #cbd5e1;
            padding: 0;
            height: 32px;
            background: white;
        }

        /* 輸入框 */
        input[type="text"], input[type="number"] {
            width: 100%; height: 100%; border: none; outline: none;
            text-align: center; font-family: inherit; font-size: 13px; background: transparent;
        }
        input:focus { background-color: #eff6ff; box-shadow: inset 0 0 0 2px #3b82f6; }
        .align-left input { text-align: left; padding-left: 5px; }

        /* 日期與排除六日 */
        .date-wrapper { display: flex; align-items: center; height: 100%; }
        .date-wrapper input[type="text"] { flex: 1; }
        .weekend-check { 
            font-size: 10px; color: #64748b; display: flex; align-items: center; 
            background: #f1f5f9; height: 100%; padding: 0 4px; border-left: 1px solid #cbd5e1; cursor: pointer;
        }
        .weekend-check input { width: auto; margin-right: 2px; }

        /* 滿版 Checkbox */
        .td-checkbox { display: flex; justify-content: center; align-items: center; height: 100%; }
        .td-checkbox input { width: 16px; height: 16px; cursor: pointer; }

        /* --- 甘特圖樣式 (統一無色版) --- */
        .month-header-row td { background-color: #e2e8f0; font-weight: bold; border-top: 2px solid #64748b; border-bottom: 1px solid #94a3b8; text-align: left; padding-left: 10px; }
        
        .gantt-visual-row { height: 12px; }
        .gantt-data-row { height: 28px; }

        /* 時間軸統一為灰色 (Excel 風格) */
        .gantt-bar { border-right: 1px solid #e2e8f0; }
        .bar-active { background-color: #64748b; border-color: #475569; } /* 統一深灰 */

        .gantt-num input { font-weight: bold; color: #000; }

        /* 每月統計列 */
        .monthly-total-row td { 
            background-color: #f8fafc; 
            border-top: 2px double #94a3b8; 
            border-bottom: 2px solid #000; 
            font-weight: bold; 
            color: #1e40af;
        }

        /* 按鈕 */
        .btn-add { width: 100%; padding: 8px; background: #fff; border: 1px dashed #94a3b8; color: #3b82f6; font-weight: bold; cursor: pointer; margin-top: 5px; }
        .btn-add:hover { background: #eff6ff; }
        
        .col-yellow { background-color: #ffffcc; }
        .col-blue { background-color: #e0f2fe; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="sidebar-header">
            <h2>訓練管理系統</h2>
        </div>
        <div class="nav-item active" onclick="switchTab(1, this)">1. 消防人員訓練</div>
        <div class="nav-item" onclick="switchTab(2, this)">2. 非消防人員訓練</div>
        <div class="nav-item" onclick="switchTab(3, this)">3. 重大活動</div>
        <div class="nav-item" onclick="switchTab(4, this)">4. 甘特圖流路</div>
    </div>

    <div class="main-content">
        <div class="top-bar">
            <h3 id="pageTitle" style="margin:0; font-size:16px;">附件1 - 消防人員訓練</h3>
            <div style="display:flex; gap:10px;">
                <button onclick="alert('Excel 下載')" style="padding:5px 15px; background:#16a34a; color:white; border:none; border-radius:4px; cursor:pointer;">下載 Excel</button>
                <button onclick="alert('PDF 下載')" style="padding:5px 15px; background:#dc2626; color:white; border:none; border-radius:4px; cursor:pointer;">下載 PDF</button>
            </div>
        </div>

        <div class="workspace">
            
            <!-- TAB 1 -->
            <div id="view1" class="view-section active">
                <div class="table-container">
                    <table id="table1">
                        <thead>
                            <tr>
                                <th style="width:40px">刪</th>
                                <th style="width:40px">項次</th>
                                <th style="width:40px">月份</th>
                                <th style="width:100px">承辦單位</th>
                                <th style="width:200px">課程名稱</th>
                                <th style="width:80px">訓練對象</th>
                                <th style="width:160px">課程日期</th>
                                <th style="width:120px">上課地點</th>
                                <th style="width:40px">梯數</th>
                                <th style="width:50px">每梯<br>人數</th>
                                <th style="width:50px">合計<br>人數</th>
                                <th style="width:50px">每天<br>時數</th>
                                <th style="width:50px">每梯<br>時數</th>
                                <th style="width:50px">合計<br>時數</th>
                                <th style="width:100px" class="col-blue"><div class="th-content">預計調用人數<br>(分隊人力)</div></th>
                                <th style="width:100px" class="col-yellow"><div class="th-content">是否提供宜基<br>北桃參訓</div></th>
                                <th style="width:60px" class="col-yellow"><div class="th-content">暫訂<br>新北</div></th>
                                <th style="width:60px" class="col-yellow"><div class="th-content">暫訂<br>基隆</div></th>
                                <th style="width:60px" class="col-yellow"><div class="th-content">暫訂<br>桃園</div></th>
                                <th style="width:60px" class="col-yellow"><div class="th-content">暫訂<br>宜蘭</div></th>
                                <th style="width:150px">備註</th>
                            </tr>
                        </thead>
                        <tbody id="tbody1"></tbody>
                    </table>
                </div>
                <button class="btn-add" onclick="addRow(1)">+ 新增</button>
            </div>

            <!-- TAB 2 -->
            <div id="view2" class="view-section">
                <div class="table-container">
                    <table id="table2">
                        <thead>
                            <tr>
                                <th style="width:40px">刪</th>
                                <th style="width:40px">序號</th>
                                <th style="width:40px">月份</th>
                                <th style="width:100px">承辦單位</th>
                                <th style="width:200px">課程名稱</th>
                                <th style="width:120px">訓練對象</th>
                                <th style="width:160px">課程日期</th>
                                <th style="width:120px">訓練地點</th>
                                <th style="width:40px">梯數</th>
                                <th style="width:50px">每梯<br>人數</th>
                                <th style="width:50px">合計<br>人數</th>
                                <th style="width:50px">每天<br>時數</th>
                                <th style="width:50px">每梯<br>時數</th>
                                <th style="width:50px">合計<br>時數</th>
                                <th style="width:80px">調用本局<br>教官人數</th>
                                <th style="width:80px"><div class="th-content">是否提供<br>跨縣市</div></th>
                                <th style="width:150px">備註</th>
                            </tr>
                        </thead>
                        <tbody id="tbody2"></tbody>
                    </table>
                </div>
                <button class="btn-add" onclick="addRow(2)">+ 新增</button>
            </div>

            <!-- TAB 3 -->
            <div id="view3" class="view-section">
                <div class="table-container">
                    <table id="table3">
                        <thead>
                            <tr>
                                <th style="width:40px">刪</th>
                                <th style="width:40px">序號</th>
                                <th style="width:100px">承辦單位</th>
                                <th style="width:250px">重大活動演習名稱</th>
                                <th style="width:150px">參加對象</th>
                                <th style="width:160px">日期</th>
                                <th style="width:50px">天數</th>
                                <th style="width:50px">時數</th>
                                <th style="width:100px" style="background:#fee2e2;"><div class="th-content">每日調用<br>外勤人數</div></th>
                                <th style="width:150px">地點(教室)</th>
                            </tr>
                        </thead>
                        <tbody id="tbody3"></tbody>
                    </table>
                </div>
                <button class="btn-add" onclick="addRow(3)">+ 新增</button>
            </div>

            <!-- TAB 4 甘特圖 -->
            <div id="view4" class="view-section">
                <div style="padding:10px; background:#fffbeb; border-bottom:1px solid #fbbf24; font-size:12px; color:#92400e;">
                    ⚠️ <strong>統計說明：</strong> 
                    1. 統計包含「附件1調用人數」、「附件2教官」、「附件3活動人數」。
                    2. 統計結果為「每日調用人數統計」。
                    3. 系統已自動依月份分組計算。
                </div>
                <div class="table-container">
                    <table id="table4">
                        <thead>
                            <tr id="ganttHeader">
                                <th style="width:250px">班期 / 活動名稱</th>
                                <!-- JS 生成 1-31 -->
                            </tr>
                        </thead>
                        <tbody id="tbody4">
                            <!-- JS 生成 -->
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>

    <script>
        // 預設資料
        let d1 = [
            {m:'1', unit:'訓練中心', name:'火災搶救初級班', date:'1/6-19', mp:20, exclude:true}
        ];
        let d2 = [
            {m:'1', unit:'應變科', name:'防災業務研習班', date:'1/13-15', inst:2, exclude:false}
        ];
        let d3 = [
            {unit:'秘書室', name:'119消防節', date:'1/16', mp:25, exclude:false}
        ];

        function switchTab(idx, btn) {
            document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
            btn.classList.add('active');
            document.querySelectorAll('.view-section').forEach(e => e.classList.remove('active'));
            document.getElementById(`view${idx}`).classList.add('active');
            
            const titles = ['附件1 - 消防人員', '附件2 - 非消防人員', '附件3 - 重大活動', '甘特圖 - 訓練流路'];
            document.getElementById('pageTitle').innerText = titles[idx-1];

            if(idx===4) renderGantt();
        }

        // 渲染 Table 1
        function renderT1() {
            const tb = document.getElementById('tbody1');
            tb.innerHTML = '';
            d1.forEach((r,i) => {
                tb.innerHTML += `<tr>
                    <td><button onclick="del(1,${i})" style="width:100%;color:#ccc;background:none;border:none;cursor:pointer;">×</button></td>
                    <td><input type="text" value="${i+1}" readonly></td>
                    <td><input type="text" value="${r.m||''}" onchange="d1[${i}].m=this.value"></td>
                    <td><input type="text" value="${r.unit||''}" onchange="d1[${i}].unit=this.value"></td>
                    <td class="align-left"><input type="text" value="${r.name||''}" onchange="d1[${i}].name=this.value"></td>
                    <td><input type="text" value="${r.target||''}" onchange="d1[${i}].target=this.value"></td>
                    <td>
                        <div class="date-wrapper">
                            <input type="text" value="${r.date||''}" onchange="d1[${i}].date=this.value" placeholder="1/6-19">
                            <label class="weekend-check"><input type="checkbox" ${r.exclude?'checked':''} onchange="d1[${i}].exclude=this.checked">排除六日</label>
                        </div>
                    </td>
                    <td><input type="text" value="${r.loc||''}" onchange="d1[${i}].loc=this.value"></td>
                    <td><input type="number" value="${r.batch||''}" onchange="d1[${i}].batch=this.value"></td>
                    <td><input type="number" value="${r.pBatch||''}" onchange="d1[${i}].pBatch=this.value"></td>
                    <td style="background:#f8fafc;text-align:center;line-height:32px;">${(r.batch*r.pBatch)||0}</td>
                    <td><input type="number" value="${r.dHour||''}" onchange="d1[${i}].dHour=this.value"></td>
                    <td><input type="number" value="${r.bHour||''}" onchange="d1[${i}].bHour=this.value"></td>
                    <td style="background:#f8fafc;text-align:center;line-height:32px;">${(r.batch*r.bHour)||0}</td>
                    <td style="background:#e0f2fe;"><input type="number" value="${r.mp||''}" onchange="d1[${i}].mp=this.value" style="color:#1e40af;font-weight:bold;"></td>
                    <td class="td-checkbox"><input type="checkbox" ${r.ext?'checked':''} onchange="d1[${i}].ext=this.checked"></td>
                    <td><input type="number" value="${r.nt||''}" onchange="d1[${i}].nt=this.value"></td>
                    <td><input type="number" value="${r.kl||''}" onchange="d1[${i}].kl=this.value"></td>
                    <td><input type="number" value="${r.ty||''}" onchange="d1[${i}].ty=this.value"></td>
                    <td><input type="number" value="${r.yl||''}" onchange="d1[${i}].yl=this.value"></td>
                    <td class="align-left"><input type="text" value="${r.note||''}" onchange="d1[${i}].note=this.value"></td>
                </tr>`;
            });
        }

        // 渲染 Table 2
        function renderT2() {
            const tb = document.getElementById('tbody2');
            tb.innerHTML = '';
            d2.forEach((r,i) => {
                tb.innerHTML += `<tr>
                    <td><button onclick="del(2,${i})" style="width:100%;color:#ccc;background:none;border:none;cursor:pointer;">×</button></td>
                    <td><input type="text" value="${i+1}" readonly></td>
                    <td><input type="text" value="${r.m||''}" onchange="d2[${i}].m=this.value"></td>
                    <td><input type="text" value="${r.unit||''}" onchange="d2[${i}].unit=this.value"></td>
                    <td class="align-left"><input type="text" value="${r.name||''}" onchange="d2[${i}].name=this.value"></td>
                    <td><input type="text" value="${r.target||''}" onchange="d2[${i}].target=this.value"></td>
                    <td>
                        <div class="date-wrapper">
                            <input type="text" value="${r.date||''}" onchange="d2[${i}].date=this.value">
                            <label class="weekend-check"><input type="checkbox" ${r.exclude?'checked':''} onchange="d2[${i}].exclude=this.checked">排除六日</label>
                        </div>
                    </td>
                    <td><input type="text" value="${r.loc||''}" onchange="d2[${i}].loc=this.value"></td>
                    <td><input type="number" value="${r.batch||''}" onchange="d2[${i}].batch=this.value"></td>
                    <td><input type="number" value="${r.pBatch||''}" onchange="d2[${i}].pBatch=this.value"></td>
                    <td style="background:#f8fafc;text-align:center;line-height:32px;">${(r.batch*r.pBatch)||0}</td>
                    <td><input type="number" value="${r.dHour||''}" onchange="d2[${i}].dHour=this.value"></td>
                    <td><input type="number" value="${r.bHour||''}" onchange="d2[${i}].bHour=this.value"></td>
                    <td style="background:#f8fafc;text-align:center;line-height:32px;">${(r.batch*r.bHour)||0}</td>
                    <td><input type="number" value="${r.inst||''}" onchange="d2[${i}].inst=this.value"></td>
                    <td class="td-checkbox"><input type="checkbox" ${r.ext?'checked':''} onchange="d2[${i}].ext=this.checked"></td>
                    <td class="align-left"><input type="text" value="${r.note||''}" onchange="d2[${i}].note=this.value"></td>
                </tr>`;
            });
        }

        // 渲染 Table 3
        function renderT3() {
            const tb = document.getElementById('tbody3');
            tb.innerHTML = '';
            d3.forEach((r,i) => {
                tb.innerHTML += `<tr>
                    <td><button onclick="del(3,${i})" style="width:100%;color:#ccc;background:none;border:none;cursor:pointer;">×</button></td>
                    <td><input type="text" value="${i+1}" readonly></td>
                    <td><input type="text" value="${r.unit||''}" onchange="d3[${i}].unit=this.value"></td>
                    <td class="align-left"><input type="text" value="${r.name||''}" onchange="d3[${i}].name=this.value"></td>
                    <td><input type="text" value="${r.target||''}" onchange="d3[${i}].target=this.value"></td>
                    <td>
                        <div class="date-wrapper">
                            <input type="text" value="${r.date||''}" onchange="d3[${i}].date=this.value" placeholder="1/16">
                            <label class="weekend-check"><input type="checkbox" ${r.exclude?'checked':''} onchange="d3[${i}].exclude=this.checked">排除六日</label>
                        </div>
                    </td>
                    <td><input type="number" value="${r.days||''}" onchange="d3[${i}].days=this.value"></td>
                    <td><input type="number" value="${r.hours||''}" onchange="d3[${i}].hours=this.value"></td>
                    <td><input type="number" value="${r.mp||''}" onchange="d3[${i}].mp=this.value" style="color:#ef4444;font-weight:bold;"></td>
                    <td class="align-left"><input type="text" value="${r.loc||''}" onchange="d3[${i}].loc=this.value"></td>
                </tr>`;
            });
        }

        // 甘特圖邏輯
        function renderGantt() {
            // 表頭
            const h = document.getElementById('ganttHeader');
            h.innerHTML = '<th style="width:250px">班期 / 活動名稱</th>';
            for(let i=1;i<=31;i++) h.innerHTML += `<th style="width:30px">${i}</th>`;

            const tb = document.getElementById('tbody4');
            tb.innerHTML = '';

            // 1. 資料彙整與日期解析 (含週末排除)
            let rows = [];
            const parse = (str, month, exclude) => {
                let d = []; if(!str) return d;
                try {
                    let s = str.replace(/\(.*\)/g,'').trim();
                    let rng = s.match(/(\d+)\/(\d+)-(\d+)/);
                    let sgl = s.match(/(\d+)\/(\d+)/);

                    let daysToAdd = [];
                    if(rng) for(let i=+rng[2];i<=+rng[3];i++) daysToAdd.push(i);
                    else if(sgl) daysToAdd.push(+sgl[2]);
                    else if(s.includes(',')) s.split(',').forEach(p=>daysToAdd.push(parseInt(p)));

                    // 排除六日邏輯 (2025年)
                    daysToAdd.forEach(day => {
                        if(exclude) {
                            // 注意：JS Month 是 0-11
                            let date = new Date(2025, month-1, day); 
                            let w = date.getDay();
                            if(w !== 0 && w !== 6) d.push(day);
                        } else {
                            d.push(day);
                        }
                    });
                } catch(e){}
                return d;
            };

            // 收集所有資料
            d1.forEach(r => { if(r.date && r.mp) rows.push({m:r.m||'1', n:r.name, ds:parse(r.date, r.m||1, r.exclude), v:r.mp}); });
            d2.forEach(r => { if(r.date && r.inst) rows.push({m:r.m||'1', n:r.name, ds:parse(r.date, r.m||1, r.exclude), v:r.inst}); });
            d3.forEach(r => { 
                if(r.date && r.mp) {
                    let m = r.date.split('/')[0]||'1';
                    rows.push({m:m, n:r.name, ds:parse(r.date, m, r.exclude), v:r.mp}); 
                }
            });

            // 2. 依月份分組
            let grouped = {};
            for(let i=1; i<=12; i++) grouped[i] = [];
            rows.forEach(r => { if(grouped[r.m]) grouped[r.m].push(r); });

            // 3. 渲染 (按月份)
            for(let m=1; m<=12; m++) {
                if(grouped[m].length === 0) continue;

                // 月份標題列
                tb.innerHTML += `<tr class="month-header-row"><td colspan="32">${m} 月份</td></tr>`;

                let monthlySum = Array(32).fill(0);

                // 該月所有活動
                grouped[m].forEach(r => {
                    // 上列 (時間軸)
                    let trVis = `<tr class="gantt-visual-row">
                        <td style="border-right:1px solid #cbd5e1; border-bottom:none;"></td>`; // 空格子對應名稱
                    
                    // 下列 (數據)
                    let trDat = `<tr class="gantt-data-row">
                        <td class="align-left" style="padding-left:10px; font-size:12px; border-top:none;">${r.n}</td>`;

                    for(let i=1; i<=31; i++) {
                        let active = r.ds.includes(i);
                        if(active) monthlySum[i] += parseInt(r.v);

                        // 視覺格 (純色塊)
                        trVis += `<td class="gantt-bar ${active?'bar-active':''}"></td>`;
                        // 數據格
                        trDat += `<td class="gantt-num">${active ? `<input type="text" value="${r.v}" readonly>` : ''}</td>`;
                    }
                    trVis += '</tr>';
                    trDat += '</tr>';
                    tb.innerHTML += trVis + trDat;
                });

                // 月份統計列 (放在該月最後)
                let trSum = `<tr class="monthly-total-row"><td>每日調用人數統計</td>`;
                for(let i=1; i<=31; i++) {
                    trSum += `<td>${monthlySum[i]>0 ? monthlySum[i] : ''}</td>`;
                }
                trSum += `</tr>`;
                tb.innerHTML += trSum;
            }
        }

        function addRow(t) { if(t==1)d1.push({});if(t==2)d2.push({});if(t==3)d3.push({}); renderAll(); }
        function del(t,i) { if(confirm('確認刪除?')){if(t==1)d1.splice(i,1);if(t==2)d2.splice(i,1);if(t==3)d3.splice(i,1); renderAll();}}
        function renderAll(){ renderT1(); renderT2(); renderT3(); }
        
        renderAll();
    </script>
</body>
</html>
