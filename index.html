<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‡ºåŒ—å¸‚æ”¿åºœæ¶ˆé˜²å±€ 114å¹´æ•™è‚²è¨“ç·´ç®¡ç†ç³»çµ± (é›²ç«¯æ•´åˆç‰ˆ)</title>
    
    <!-- å¼•å…¥ Excel è™•ç†å¼•æ“ -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

    <style>
        /* --- æ ¸å¿ƒè®Šæ•¸ --- */
        :root {
            --sidebar-bg: #1e293b;
            --active-item: #334155;
            --accent: #3b82f6; /* è—è‰²ä¸»èª¿ */
            --bg-color: #f1f5f9;
            --border-color: #cbd5e1;
            --header-bg: #f8fafc;
        }

        body {
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
            color: #333;
        }

        /* --- è¼‰å…¥ä¸­é®ç½© --- */
        #loadingOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 9999; display: none;
            justify-content: center; align-items: center; color: white;
            flex-direction: column; font-size: 18px; backdrop-filter: blur(3px);
        }
        .spinner {
            border: 4px solid #f3f3f3; border-top: 4px solid var(--accent);
            border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- å´é‚Šæ¬„ --- */
        .sidebar {
            width: 240px; background-color: var(--sidebar-bg); color: white;
            display: flex; flex-direction: column; flex-shrink: 0;
        }
        .sidebar-header { padding: 20px; background-color: #0f172a; border-bottom: 1px solid #334155; }
        .sidebar-header h2 { margin: 0; font-size: 18px; letter-spacing: 1px; }
        .nav-item {
            padding: 15px 20px; cursor: pointer; border-left: 4px solid transparent;
            color: #94a3b8; display: flex; align-items: center; gap: 10px;
            transition: 0.2s; font-size: 14px;
        }
        .nav-item:hover { background-color: var(--active-item); color: white; }
        .nav-item.active { background-color: var(--active-item); color: var(--accent); border-left-color: var(--accent); font-weight: bold; }

        /* --- ä¸»å…§å®¹å€ --- */
        .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .top-bar {
            height: 55px; background: white; border-bottom: 1px solid var(--border-color);
            display: flex; align-items: center; justify-content: space-between; padding: 0 25px;
        }
        .page-title { font-size: 18px; font-weight: 600; color: #1e293b; }
        .status-text { font-size: 12px; color: #64748b; margin-right: 10px; }

        .workspace { flex: 1; padding: 20px; overflow: hidden; display: flex; flex-direction: column; }
        .view-section {
            display: none; height: 100%; flex-direction: column; background: white;
            border: 1px solid var(--border-color); border-radius: 6px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); overflow: hidden;
        }
        .view-section.active { display: flex; }
        .table-container { flex: 1; overflow: auto; }

        /* --- è¡¨æ ¼æ¨£å¼ --- */
        table { border-collapse: collapse; font-size: 13px; table-layout: fixed; width: 100%; }
        #table1 { min-width: 2000px; } #table2 { min-width: 1800px; } #table3 { min-width: 1400px; } #table4 { min-width: 1600px; }

        th {
            background-color: var(--header-bg); color: #475569; font-weight: 700;
            border: 1px solid #94a3b8; text-align: center; vertical-align: middle;
            position: sticky; top: 0; z-index: 10; height: 50px; padding: 4px;
        }
        .th-content { display: flex; align-items: center; justify-content: center; width: 100%; height: 100%; line-height: 1.4; white-space: normal; }
        td { border: 1px solid #cbd5e1; padding: 0; height: 36px; background: white; position: relative; }

        /* --- è¼¸å…¥æ¡†èˆ‡å…ƒä»¶ --- */
        input[type="text"], input[type="number"] {
            width: 100%; height: 100%; border: none; outline: none;
            background: transparent; text-align: center; font-family: inherit; font-size: 13px;
        }
        input:focus { background-color: #eff6ff; box-shadow: inset 0 0 0 2px var(--accent); }
        .align-left input { text-align: left; padding-left: 8px; }

        /* --- æ—¥æœŸè¨­å®šæŒ‰éˆ• --- */
        .date-cell { display: flex; height: 100%; }
        .date-cell input { flex: 1; }
        .btn-calendar {
            width: 30px; border: none; border-left: 1px solid #cbd5e1; cursor: pointer;
            background: #f1f5f9; font-size: 14px; display: flex; align-items: center; justify-content: center;
        }
        .btn-calendar:hover { background: #e2e8f0; }

        /* --- ä»¿ Excel å‹¾é¸æ¡† --- */
        .td-checkbox { text-align: center !important; vertical-align: middle !important; padding: 0 !important; }
        .excel-checkbox {
            appearance: none; -webkit-appearance: none; width: 18px; height: 18px;
            border: 1px solid #000; background-color: white; cursor: pointer;
            display: inline-block; position: relative; vertical-align: middle; margin: 0;
        }
        .excel-checkbox:checked::after {
            content: 'âœ“'; font-size: 16px; font-weight: 900; color: #000;
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
        }

        /* --- ç”˜ç‰¹åœ– (è—è‰² + å°é½Š) --- */
        .gantt-header-month td {
            background-color: #e2e8f0; font-weight: bold; text-align: left; padding-left: 15px;
            border-top: 2px solid #475569; border-bottom: 1px solid #94a3b8; color: #1e293b;
        }
        .gantt-visual-row { height: 15px; }
        .gantt-data-row { height: 30px; }
        
        .gantt-cell-bar { border-right: 1px solid #e2e8f0; border-bottom: none; }
        .gantt-num { border-top: none; }

        /* è—è‰²è‰²å¡Š (Blue) */
        .bar-active { background-color: #3b82f6 !important; border-color: #2563eb; }
        .gantt-num input { font-weight: bold; color: #0f172a; font-size: 12px; }

        /* æ¯æ—¥çµ±è¨ˆ */
        .stats-row td {
            background-color: #f1f5f9; border-top: 2px double #94a3b8; border-bottom: 2px solid #333;
            color: #1e40af; font-weight: bold; font-size: 12px; text-align: center;
        }

        /* --- æ—¥æœŸæ’é™¤å½ˆçª— (Modal) --- */
        #dateModal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 2000; justify-content: center; align-items: center;
        }
        .modal-content {
            background: white; width: 400px; padding: 20px; border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        .modal-header { font-weight: bold; margin-bottom: 10px; font-size: 16px; display: flex; justify-content: space-between; }
        .calendar-grid {
            display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin: 15px 0;
        }
        .day-btn {
            padding: 8px; border: 1px solid #cbd5e1; background: white; cursor: pointer;
            text-align: center; font-size: 13px; border-radius: 4px;
        }
        .day-btn.active-range { background-color: #dbeafe; color: #1e40af; border-color: #3b82f6; font-weight: bold; }
        .day-btn.excluded { background-color: #64748b; color: white; text-decoration: line-through; border-color: #475569; }
        .day-btn.disabled { background-color: #f1f5f9; color: #ccc; cursor: not-allowed; border-color: #f1f5f9; }
        
        .modal-footer { display: flex; justify-content: flex-end; gap: 10px; }
        .btn-modal { padding: 8px 16px; border-radius: 4px; cursor: pointer; border: none; font-size: 13px; }
        .btn-cancel { background: #e2e8f0; color: #333; }
        .btn-confirm { background: #3b82f6; color: white; }

        /* --- æŒ‰éˆ•èˆ‡åŠŸèƒ½ --- */
        .btn-action {
            padding: 6px 16px; border-radius: 4px; border: none; color: white; 
            font-size: 13px; cursor: pointer; margin-left: 8px;
        }
        .btn-save { background-color: #0f172a; }
        .btn-add-row { width: 100%; padding: 10px; background: #fff; border: 1px dashed #94a3b8; color: var(--accent); font-weight: bold; cursor: pointer; }
        .col-yellow { background-color: #ffffcc; } .col-blue-light { background-color: #e0f2fe; } .col-red-light { background-color: #fee2e2; }
        .text-manpower { color: #1d4ed8; font-weight: bold; } .text-danger { color: #ef4444; font-weight: bold; }

        /* --- åˆ—å°æ¨£å¼ (A3 æ©«å¼) --- */
        @media print {
            @page { size: A3 landscape; margin: 10mm; }
            body { background: white; overflow: visible; height: auto; }
            .sidebar, .top-bar button, .btn-add-row, .del-btn, .btn-calendar, #loadingOverlay { display: none !important; }
            .main-content, .workspace, .view-section, .table-container { 
                width: 100%; height: auto; overflow: visible; display: block; 
            }
            .view-section { display: none; border: none; box-shadow: none; }
            .view-section.active { display: block; }
            table { width: 100%; table-layout: auto; }
            th, td { border: 1px solid #000; }
            * { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        }
    </style>
</head>
<body>

    <!-- Loading é®ç½© -->
    <div id="loadingOverlay">
        <div class="spinner"></div>
        <div id="loadingText">è³‡æ–™å‚³è¼¸ä¸­...</div>
    </div>

    <!-- æ—¥æœŸæ’é™¤å½ˆçª— -->
    <div id="dateModal">
        <div class="modal-content">
            <div class="modal-header">
                <span>æ’é™¤æ—¥æœŸè¨­å®š</span>
                <span style="font-size:12px; color:#666; font-weight:normal;">è«‹é»æ“Šè¦æ’é™¤çš„æ—¥å­</span>
            </div>
            <div style="font-size:13px; color:#1e40af; margin-bottom:5px;" id="modalRangeText">ç¯„åœ: 1/6 - 1/19</div>
            <div class="calendar-grid" id="calendarGrid"></div>
            <div class="modal-footer">
                <button class="btn-modal btn-cancel" onclick="closeModal()">å–æ¶ˆ</button>
                <button class="btn-modal btn-confirm" onclick="saveModal()">ç¢ºå®š</button>
            </div>
        </div>
    </div>

    <div class="sidebar">
        <div class="sidebar-header">
            <h2>æ•™è‚²è¨“ç·´ç®¡ç†ç³»çµ±</h2>
            <span style="font-size:11px; color:#94a3b8">é›²ç«¯æ•´åˆç‰ˆ v3.0</span>
        </div>
        <nav>
            <div class="nav-item active" onclick="switchTab(1, this)">1. æ¶ˆé˜²äººå“¡è¨“ç·´</div>
            <div class="nav-item" onclick="switchTab(2, this)">2. éæ¶ˆé˜²äººå“¡è¨“ç·´</div>
            <div class="nav-item" onclick="switchTab(3, this)">3. é‡å¤§æ´»å‹•</div>
            <div class="nav-item" onclick="switchTab(4, this)">4. ç”˜ç‰¹åœ–æµè·¯</div>
        </nav>
    </div>

    <div class="main-content">
        <div class="top-bar">
            <div class="page-title" id="pageTitle">é™„ä»¶1 - æ¶ˆé˜²äººå“¡è¨“ç·´</div>
            <div style="display:flex; align-items:center;">
                <span class="status-text" id="lastSaveTime">å°šæœªåŒæ­¥</span>
                <button class="btn-action btn-save" onclick="saveData()">â˜ï¸ å„²å­˜è³‡æ–™</button>
                <button class="btn-action" style="background:#16a34a" onclick="exportRealExcel()">ğŸ“¥ ä¸‹è¼‰ Excel</button>
                <button class="btn-action" style="background:#dc2626" onclick="window.print()">ğŸ–¨ï¸ åˆ—å° PDF</button>
            </div>
        </div>

        <div class="workspace">
            <!-- TAB 1 -->
            <div id="view1" class="view-section active"><div class="table-container"><table id="table1"><thead><tr><th style="width:40px" class="del-btn">åˆª</th><th style="width:40px">é …æ¬¡</th><th style="width:40px">æœˆä»½</th><th style="width:100px">æ‰¿è¾¦å–®ä½</th><th style="width:200px">èª²ç¨‹åç¨±</th><th style="width:80px">è¨“ç·´å°è±¡</th><th style="width:140px">èª²ç¨‹æ—¥æœŸ</th><th style="width:120px">ä¸Šèª²åœ°é»</th><th style="width:40px">æ¢¯æ•¸</th><th style="width:50px">æ¯æ¢¯<br>äººæ•¸</th><th style="width:50px">åˆè¨ˆ<br>äººæ•¸</th><th style="width:50px">æ¯å¤©<br>æ™‚æ•¸</th><th style="width:50px">æ¯æ¢¯<br>æ™‚æ•¸</th><th style="width:50px">åˆè¨ˆ<br>æ™‚æ•¸</th><th style="width:100px" class="col-blue-light"><div class="th-content">é è¨ˆèª¿ç”¨äººæ•¸<br>(åˆ†éšŠäººåŠ›)</div></th><th style="width:120px" class="col-yellow"><div class="th-content">æ˜¯å¦æä¾›å®œåŸº<br>åŒ—æ¡ƒåƒè¨“</div></th><th style="width:60px" class="col-yellow"><div class="th-content">æš«è¨‚<br>æ–°åŒ—</div></th><th style="width:60px" class="col-yellow"><div class="th-content">æš«è¨‚<br>åŸºéš†</div></th><th style="width:60px" class="col-yellow"><div class="th-content">æš«è¨‚<br>æ¡ƒåœ’</div></th><th style="width:60px" class="col-yellow"><div class="th-content">æš«è¨‚<br>å®œè˜­</div></th><th style="width:150px">å‚™è¨»</th></tr></thead><tbody id="tbody1"></tbody></table></div><button class="btn-add-row" onclick="addRow(1)">+ æ–°å¢ æ¶ˆé˜²äººå“¡èª²ç¨‹</button></div>

            <!-- TAB 2 -->
            <div id="view2" class="view-section"><div class="table-container"><table id="table2"><thead><tr><th style="width:40px" class="del-btn">åˆª</th><th style="width:40px">åºè™Ÿ</th><th style="width:40px">æœˆä»½</th><th style="width:100px">æ‰¿è¾¦å–®ä½</th><th style="width:200px">èª²ç¨‹åç¨±</th><th style="width:120px">è¨“ç·´å°è±¡</th><th style="width:140px">èª²ç¨‹æ—¥æœŸ</th><th style="width:120px">è¨“ç·´åœ°é»</th><th style="width:40px">æ¢¯æ•¸</th><th style="width:50px">æ¯æ¢¯<br>äººæ•¸</th><th style="width:50px">åˆè¨ˆ<br>äººæ•¸</th><th style="width:50px">æ¯å¤©<br>æ™‚æ•¸</th><th style="width:50px">æ¯æ¢¯<br>æ™‚æ•¸</th><th style="width:50px">åˆè¨ˆ<br>æ™‚æ•¸</th><th style="width:80px">èª¿ç”¨æœ¬å±€<br>æ•™å®˜äººæ•¸</th><th style="width:100px"><div class="th-content">æ˜¯å¦æä¾›<br>è·¨ç¸£å¸‚</div></th><th style="width:150px">å‚™è¨»</th></tr></thead><tbody id="tbody2"></tbody></table></div><button class="btn-add-row" onclick="addRow(2)">+ æ–°å¢ éæ¶ˆé˜²äººå“¡èª²ç¨‹</button></div>

            <!-- TAB 3 -->
            <div id="view3" class="view-section"><div class="table-container"><table id="table3"><thead><tr><th style="width:40px" class="del-btn">åˆª</th><th style="width:40px">åºè™Ÿ</th><th style="width:100px">æ‰¿è¾¦å–®ä½</th><th style="width:250px">é‡å¤§æ´»å‹•æ¼”ç¿’åç¨±</th><th style="width:150px">åƒåŠ å°è±¡</th><th style="width:140px">æ—¥æœŸ</th><th style="width:50px">å¤©æ•¸</th><th style="width:50px">æ™‚æ•¸</th><th style="width:100px" class="col-red-light"><div class="th-content">æ¯æ—¥èª¿ç”¨<br>å¤–å‹¤äººæ•¸</div></th><th style="width:150px">åœ°é»(æ•™å®¤)</th></tr></thead><tbody id="tbody3"></tbody></table></div><button class="btn-add-row" onclick="addRow(3)">+ æ–°å¢ é‡å¤§æ´»å‹•</button></div>

            <!-- TAB 4 -->
            <div id="view4" class="view-section"><div style="padding:12px;background:#fffbeb;border-bottom:1px solid #fbbf24;font-size:13px;color:#92400e;">âš ï¸ <strong>èªªæ˜ï¼š</strong>ç”˜ç‰¹åœ–ä¾æ“šé™„ä»¶1-3çš„è³‡æ–™å³æ™‚è¨ˆç®—ã€‚è‹¥éœ€èª¿æ•´æ—¥æœŸï¼Œè«‹å›å‰é é»æ“Š ğŸ“… åœ–ç¤ºã€‚</div><div class="table-container"><table id="table4"><thead><tr id="ganttHeader"><th style="width:250px">ç­æœŸ / æ´»å‹•åç¨±</th></tr></thead><tbody id="tbody4"></tbody></table></div></div>
        </div>
    </div>

    <script>
        // ==========================================
        // âš ï¸ è«‹åœ¨æ­¤è™•è²¼ä¸Šæ‚¨çš„ GAS ç¶²é æ‡‰ç”¨ç¨‹å¼ç¶²å€
        // ==========================================
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbwR6rt6eknue_0J5Jb1yUdlHx-IKBmNcUc49XRHtEkd8Gj7M5sLtzEutcw8aSIlN0cYrg/exec"; 

        // è³‡æ–™çµæ§‹ (å¢åŠ  excludeList: [] ç”¨ä¾†å­˜æ’é™¤çš„æ—¥æœŸ)
        let d1 = [{m:'1', unit:'', name:'', date:'', mp:0, excludeList:[], ext:false}];
        let d2 = [{m:'1', unit:'', name:'', date:'', inst:0, excludeList:[], ext:false}];
        let d3 = [{unit:'', name:'', date:'', mp:0, excludeList:[]}];

        // --- åˆå§‹åŒ– ---
        window.onload = function() {
            loadData();
        };

        // --- è¼‰å…¥è³‡æ–™ ---
        function loadData() {
            if(GAS_API_URL.includes("è«‹è²¼ä¸Š")) {
                alert("è«‹å…ˆä¿®æ”¹ç¨‹å¼ç¢¼ä¸­çš„ GAS_API_URL è®Šæ•¸ï¼ç›®å‰ä½¿ç”¨é è¨­ç©ºè³‡æ–™ã€‚");
                renderAll();
                return;
            }
            showLoading(true, "æ­£åœ¨è®€å–é›²ç«¯è³‡æ–™åº«...");
            
            fetch(GAS_API_URL)
            .then(res => res.json())
            .then(json => {
                if(json.status === 'success') {
                    // Mapping Logic: å°‡äºŒç¶­é™£åˆ—è½‰å›ç‰©ä»¶
                    // Data1: [Month, Unit, Name, Target, Date, Loc, Batch, PBatch, TotalP, DHour, BHour, TotalH, MP, Ext, NT, KL, TY, YL, Note, ExcludeJSON]
                    d1 = (json.data1 || []).map(r => ({
                        m: r[0], unit: r[1], name: r[2], target: r[3], date: r[4], loc: r[5], 
                        batch: r[6], pBatch: r[7], dHour: r[9], bHour: r[10], mp: r[12], 
                        ext: r[13]==='true', nt: r[14], kl: r[15], ty: r[16], yl: r[17], note: r[18],
                        excludeList: JSON.parse(r[19] || "[]")
                    }));
                    // Data2
                    d2 = (json.data2 || []).map(r => ({
                        m: r[0], unit: r[1], name: r[2], target: r[3], date: r[4], loc: r[5],
                        batch: r[6], pBatch: r[7], dHour: r[9], bHour: r[10], inst: r[12],
                        ext: r[13]==='true', note: r[14], excludeList: JSON.parse(r[15] || "[]")
                    }));
                    // Data3
                    d3 = (json.data3 || []).map(r => ({
                        unit: r[0], name: r[1], target: r[2], date: r[3], days: r[4], hours: r[5],
                        mp: r[6], loc: r[7], excludeList: JSON.parse(r[8] || "[]")
                    }));

                    if(d1.length===0) addRow(1);
                    if(d2.length===0) addRow(2);
                    if(d3.length===0) addRow(3);
                    
                    renderAll();
                    document.getElementById('lastSaveTime').innerText = "å·²åŒæ­¥";
                }
            })
            .catch(err => alert("è®€å–å¤±æ•—: " + err))
            .finally(() => showLoading(false));
        }

        // --- å„²å­˜è³‡æ–™ ---
        function saveData() {
            if(GAS_API_URL.includes("è«‹è²¼ä¸Š")) return alert("è«‹è¨­å®š API ç¶²å€");
            showLoading(true, "æ­£åœ¨å¯«å…¥ Google Sheet...");

            // Mapping Logic: ç‰©ä»¶è½‰äºŒç¶­é™£åˆ—
            const p1 = d1.map(r => [r.m, r.unit, r.name, r.target, r.date, r.loc, r.batch, r.pBatch, (r.batch*r.pBatch)||0, r.dHour, r.bHour, (r.batch*r.bHour)||0, r.mp, r.ext, r.nt, r.kl, r.ty, r.yl, r.note, JSON.stringify(r.excludeList)]);
            const p2 = d2.map(r => [r.m, r.unit, r.name, r.target, r.date, r.loc, r.batch, r.pBatch, (r.batch*r.pBatch)||0, r.dHour, r.bHour, (r.batch*r.bHour)||0, r.inst, r.ext, r.note, JSON.stringify(r.excludeList)]);
            const p3 = d3.map(r => [r.unit, r.name, r.target, r.date, r.days, r.hours, r.mp, r.loc, JSON.stringify(r.excludeList)]);

            fetch(GAS_API_URL, {
                method: 'POST',
                body: JSON.stringify({ d1: p1, d2: p2, d3: p3 }),
                headers: { 'Content-Type': 'text/plain' } // é¿å… CORS Preflight
            })
            .then(res => res.json())
            .then(json => {
                if(json.status === 'success') {
                    alert(json.message);
                    document.getElementById('lastSaveTime').innerText = "æœ€å¾Œå„²å­˜: " + new Date().toLocaleTimeString();
                } else {
                    alert("å„²å­˜éŒ¯èª¤: " + json.message);
                }
            })
            .catch(err => alert("é€£ç·šéŒ¯èª¤: " + err))
            .finally(() => showLoading(false));
        }

        // --- UI äº’å‹• ---
        function switchTab(idx, btn) {
            document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
            btn.classList.add('active');
            document.querySelectorAll('.view-section').forEach(e => e.classList.remove('active'));
            document.getElementById(`view${idx}`).classList.add('active');
            const titles = ['é™„ä»¶1 - æ¶ˆé˜²äººå“¡è¨“ç·´', 'é™„ä»¶2 - éæ¶ˆé˜²äººå“¡è¨“ç·´', 'é™„ä»¶3 - é‡å¤§æ´»å‹•', 'ç”˜ç‰¹åœ– - è¨“ç·´æµè·¯'];
            document.getElementById('pageTitle').innerText = titles[idx-1];
            if(idx === 4) renderGantt();
        }

        function showLoading(show, text) {
            document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
            if(text) document.getElementById('loadingText').innerText = text;
        }

        // --- å½ˆçª—é‚è¼¯ (Calendar Modal) ---
        let currentEdit = { type: 0, index: 0 };

        function openDateModal(type, index) {
            currentEdit = { type, index };
            const row = (type===1 ? d1 : type===2 ? d2 : d3)[index];
            const dateStr = row.date;
            
            // è§£ææ—¥æœŸç¯„åœ
            const days = parseDates(dateStr); // å–å¾—æ‰€æœ‰æœ‰æ•ˆæ—¥æœŸ
            if(days.length === 0) {
                alert("è«‹å…ˆè¼¸å…¥æœ‰æ•ˆçš„æ—¥æœŸæ ¼å¼ (ä¾‹å¦‚ 1/6-19) å†é€²è¡Œæ’é™¤è¨­å®šã€‚");
                return;
            }

            document.getElementById('modalRangeText').innerText = `åŸå§‹ç¯„åœåŒ…å« ${days.length} å¤©`;
            
            // ç”ŸæˆæŒ‰éˆ• (1-31)
            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';
            
            for(let i=1; i<=31; i++) {
                const btn = document.createElement('div');
                btn.className = 'day-btn';
                btn.innerText = i;
                
                // ç‹€æ…‹åˆ¤æ–·
                const isInRange = days.includes(i);
                const isExcluded = (row.excludeList || []).includes(i);

                if(!isInRange) {
                    btn.classList.add('disabled');
                } else {
                    btn.classList.add('active-range');
                    if(isExcluded) btn.classList.add('excluded');
                    
                    // é»æ“Šåˆ‡æ›æ’é™¤ç‹€æ…‹
                    btn.onclick = function() {
                        this.classList.toggle('excluded');
                    };
                }
                grid.appendChild(btn);
            }
            
            document.getElementById('dateModal').style.display = 'flex';
        }

        function closeModal() { document.getElementById('dateModal').style.display = 'none'; }

        function saveModal() {
            const btns = document.querySelectorAll('.day-btn.active-range.excluded');
            const excluded = Array.from(btns).map(b => parseInt(b.innerText));
            
            const { type, index } = currentEdit;
            const row = (type===1 ? d1 : type===2 ? d2 : d3)[index];
            row.excludeList = excluded;
            
            closeModal();
        }

        // --- æ¸²æŸ“è¡¨æ ¼ ---
        function renderT1() {
            const tb = document.getElementById('tbody1'); tb.innerHTML = '';
            d1.forEach((r, i) => {
                tb.innerHTML += `<tr>
                    <td class="del-btn"><button onclick="del(1,${i})" style="width:100%;color:#ccc;background:none;border:none;cursor:pointer;">Ã—</button></td>
                    <td><input type="text" value="${i+1}" readonly style="color:#999"></td>
                    <td><input type="text" value="${r.m||''}" onchange="d1[${i}].m=this.value"></td>
                    <td><input type="text" value="${r.unit||''}" onchange="d1[${i}].unit=this.value"></td>
                    <td class="align-left"><input type="text" value="${r.name||''}" onchange="d1[${i}].name=this.value"></td>
                    <td><input type="text" value="${r.target||''}" onchange="d1[${i}].target=this.value"></td>
                    <td><div class="date-cell"><input type="text" value="${r.date||''}" onchange="d1[${i}].date=this.value" placeholder="1/6-19"><button class="btn-calendar" onclick="openDateModal(1,${i})">ğŸ“…</button></div></td>
                    <td><input type="text" value="${r.loc||''}" onchange="d1[${i}].loc=this.value"></td>
                    <td><input type="number" value="${r.batch||''}" onchange="d1[${i}].batch=this.value"></td>
                    <td><input type="number" value="${r.pBatch||''}" onchange="d1[${i}].pBatch=this.value"></td>
                    <td style="background:#f8fafc;text-align:center;line-height:36px;">${(r.batch*r.pBatch)||0}</td>
                    <td><input type="number" value="${r.dHour||''}" onchange="d1[${i}].dHour=this.value"></td>
                    <td><input type="number" value="${r.bHour||''}" onchange="d1[${i}].bHour=this.value"></td>
                    <td style="background:#f8fafc;text-align:center;line-height:36px;">${(r.batch*r.bHour)||0}</td>
                    <td class="col-blue-light"><input type="number" value="${r.mp||''}" onchange="d1[${i}].mp=this.value" class="text-manpower"></td>
                    <td class="td-checkbox"><input type="checkbox" class="excel-checkbox" ${r.ext?'checked':''} onchange="d1[${i}].ext=this.checked"></td>
                    <td><input type="number" value="${r.nt||''}" onchange="d1[${i}].nt=this.value"></td>
                    <td><input type="number" value="${r.kl||''}" onchange="d1[${i}].kl=this.value"></td>
                    <td><input type="number" value="${r.ty||''}" onchange="d1[${i}].ty=this.value"></td>
                    <td><input type="number" value="${r.yl||''}" onchange="d1[${i}].yl=this.value"></td>
                    <td class="align-left"><input type="text" value="${r.note||''}" onchange="d1[${i}].note=this.value"></td>
                </tr>`;
            });
        }

        function renderT2() {
            const tb = document.getElementById('tbody2'); tb.innerHTML = '';
            d2.forEach((r, i) => {
                tb.innerHTML += `<tr>
                    <td class="del-btn"><button onclick="del(2,${i})" style="width:100%;color:#ccc;background:none;border:none;cursor:pointer;">Ã—</button></td>
                    <td><input type="text" value="${i+1}" readonly style="color:#999"></td>
                    <td><input type="text" value="${r.m||''}" onchange="d2[${i}].m=this.value"></td>
                    <td><input type="text" value="${r.unit||''}" onchange="d2[${i}].unit=this.value"></td>
                    <td class="align-left"><input type="text" value="${r.name||''}" onchange="d2[${i}].name=this.value"></td>
                    <td><input type="text" value="${r.target||''}" onchange="d2[${i}].target=this.value"></td>
                    <td><div class="date-cell"><input type="text" value="${r.date||''}" onchange="d2[${i}].date=this.value"><button class="btn-calendar" onclick="openDateModal(2,${i})">ğŸ“…</button></div></td>
                    <td><input type="text" value="${r.loc||''}" onchange="d2[${i}].loc=this.value"></td>
                    <td><input type="number" value="${r.batch||''}" onchange="d2[${i}].batch=this.value"></td>
                    <td><input type="number" value="${r.pBatch||''}" onchange="d2[${i}].pBatch=this.value"></td>
                    <td style="background:#f8fafc;text-align:center;line-height:36px;">${(r.batch*r.pBatch)||0}</td>
                    <td><input type="number" value="${r.dHour||''}" onchange="d2[${i}].dHour=this.value"></td>
                    <td><input type="number" value="${r.bHour||''}" onchange="d2[${i}].bHour=this.value"></td>
                    <td style="background:#f8fafc;text-align:center;line-height:36px;">${(r.batch*r.bHour)||0}</td>
                    <td><input type="number" value="${r.inst||''}" onchange="d2[${i}].inst=this.value"></td>
                    <td class="td-checkbox"><input type="checkbox" class="excel-checkbox" ${r.ext?'checked':''} onchange="d2[${i}].ext=this.checked"></td>
                    <td class="align-left"><input type="text" value="${r.note||''}" onchange="d2[${i}].note=this.value"></td>
                </tr>`;
            });
        }

        function renderT3() {
            const tb = document.getElementById('tbody3'); tb.innerHTML = '';
            d3.forEach((r, i) => {
                tb.innerHTML += `<tr>
                    <td class="del-btn"><button onclick="del(3,${i})" style="width:100%;color:#ccc;background:none;border:none;cursor:pointer;">Ã—</button></td>
                    <td><input type="text" value="${i+1}" readonly style="color:#999"></td>
                    <td><input type="text" value="${r.unit||''}" onchange="d3[${i}].unit=this.value"></td>
                    <td class="align-left"><input type="text" value="${r.name||''}" onchange="d3[${i}].name=this.value"></td>
                    <td><input type="text" value="${r.target||''}" onchange="d3[${i}].target=this.value"></td>
                    <td><div class="date-cell"><input type="text" value="${r.date||''}" onchange="d3[${i}].date=this.value"><button class="btn-calendar" onclick="openDateModal(3,${i})">ğŸ“…</button></div></td>
                    <td><input type="number" value="${r.days||''}" onchange="d3[${i}].days=this.value"></td>
                    <td><input type="number" value="${r.hours||''}" onchange="d3[${i}].hours=this.value"></td>
                    <td class="col-red-light"><input type="number" value="${r.mp||''}" onchange="d3[${i}].mp=this.value" class="text-danger"></td>
                    <td class="align-left"><input type="text" value="${r.loc||''}" onchange="d3[${i}].loc=this.value"></td>
                </tr>`;
            });
        }

        // --- è§£ææ—¥æœŸ (ç´”è§£æï¼Œä¸è™•ç†æ’é™¤) ---
        const parseDates = (str) => {
            let days = [];
            if(!str) return days;
            try {
                let s = str.replace(/\(.*\)/g, '').trim();
                let rng = s.match(/(\d+)\/(\d+)-(\d+)/);
                let sgl = s.match(/(\d+)\/(\d+)/);
                
                if(rng) for(let i=+rng[2]; i<=+rng[3]; i++) days.push(i);
                else if(sgl) days.push(+sgl[2]);
                else if(s.includes(',')) s.split(',').forEach(p => { let m=p.match(/\d+$/); if(m) days.push(+m[0]); });
            } catch(e){}
            return days;
        };

        // --- ç”˜ç‰¹åœ–æ¸²æŸ“ ---
        function renderGantt() {
            const header = document.getElementById('ganttHeader');
            header.innerHTML = '<th style="width:250px">ç­æœŸ / æ´»å‹•åç¨±</th>';
            for(let i=1; i<=31; i++) header.innerHTML += `<th style="width:30px; font-size:11px; color:#64748b;">${i}</th>`;

            const tbody = document.getElementById('tbody4');
            tbody.innerHTML = '';

            // æ”¶é›†è³‡æ–™ä¸¦éæ¿¾æ’é™¤çš„æ—¥æœŸ
            const getFinalDays = (r) => {
                const rawDays = parseDates(r.date);
                return rawDays.filter(d => !(r.excludeList || []).includes(d));
            };

            let allRows = [];
            d1.forEach(r => { if(r.date && r.mp) allRows.push({m:r.m||'1', n:r.name, ds:getFinalDays(r), v:r.mp}); });
            d2.forEach(r => { if(r.date && r.inst) allRows.push({m:r.m||'1', n:r.name, ds:getFinalDays(r), v:r.inst}); });
            d3.forEach(r => { if(r.date && r.mp) { let m=r.date.match(/^(\d+)/); allRows.push({m:m?m[1]:'1', n:r.name, ds:getFinalDays(r), v:r.mp}); }});

            let grouped = {};
            for(let i=1; i<=12; i++) grouped[i] = [];
            allRows.forEach(r => { if(grouped[r.m]) grouped[r.m].push(r); });

            for(let m=1; m<=12; m++) {
                if(grouped[m].length === 0) continue;
                tbody.innerHTML += `<tr class="gantt-header-month"><td colspan="32">${m} æœˆä»½</td></tr>`;
                let monthlySum = Array(32).fill(0);
                grouped[m].forEach(r => {
                    let trVis = `<tr class="gantt-visual-row"><td style="border-right:1px solid #cbd5e1; border-bottom:none;"></td>`; 
                    let trDat = `<tr class="gantt-data-row"><td class="align-left" style="padding-left:10px; font-size:12px; border-top:none;">${r.n}</td>`;
                    for(let i=1; i<=31; i++) {
                        let active = r.ds.includes(i);
                        if(active) monthlySum[i] += parseInt(r.v);
                        trVis += `<td class="gantt-cell-bar ${active?'bar-active':''}"></td>`;
                        trDat += `<td class="gantt-num">${active ? `<input type="text" value="${r.v}" readonly>` : ''}</td>`;
                    }
                    trVis += '</tr>'; trDat += '</tr>';
                    tbody.innerHTML += trVis + trDat;
                });
                let trStats = `<tr class="stats-row"><td>æ¯æ—¥èª¿ç”¨äººæ•¸çµ±è¨ˆ</td>`;
                for(let i=1; i<=31; i++) trStats += `<td>${monthlySum[i]>0 ? monthlySum[i] : ''}</td>`;
                trStats += `</tr>`;
                tbody.innerHTML += trStats;
            }
        }

        // --- Excel åŒ¯å‡º ---
        function exportRealExcel() {
            if(typeof XLSX === 'undefined') return alert('Excel å¼•æ“æœªè¼‰å…¥');
            
            const wb = XLSX.utils.book_new();
            // Data 1
            const d1_out = [["é …æ¬¡","æœˆä»½","æ‰¿è¾¦å–®ä½","èª²ç¨‹åç¨±","è¨“ç·´å°è±¡","èª²ç¨‹æ—¥æœŸ","æ’é™¤æ—¥æœŸ","ä¸Šèª²åœ°é»","æ¢¯æ•¸","æ¯æ¢¯äººæ•¸","åˆè¨ˆäººæ•¸","æ¯å¤©æ™‚æ•¸","æ¯æ¢¯æ™‚æ•¸","åˆè¨ˆæ™‚æ•¸","é è¨ˆèª¿ç”¨äººæ•¸","æ˜¯å¦æä¾›å®œåŸºåŒ—æ¡ƒåƒè¨“","æš«è¨‚æ–°åŒ—","æš«è¨‚åŸºéš†","æš«è¨‚æ¡ƒåœ’","æš«è¨‚å®œè˜­","å‚™è¨»"], 
                            ...d1.map((r,i)=>[i+1,r.m,r.unit,r.name,r.target,r.date,(r.excludeList||[]).join(','),r.loc,r.batch,r.pBatch,(r.batch*r.pBatch)||0,r.dHour,r.bHour,(r.batch*r.bHour)||0,r.mp,r.ext?'æ˜¯':'å¦',r.nt,r.kl,r.ty,r.yl,r.note])];
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(d1_out), "é™„ä»¶1");
            // Data 2
            const d2_out = [["åºè™Ÿ","æœˆä»½","æ‰¿è¾¦å–®ä½","èª²ç¨‹åç¨±","è¨“ç·´å°è±¡","èª²ç¨‹æ—¥æœŸ","æ’é™¤æ—¥æœŸ","è¨“ç·´åœ°é»","æ¢¯æ•¸","æ¯æ¢¯äººæ•¸","åˆè¨ˆäººæ•¸","æ¯å¤©æ™‚æ•¸","æ¯æ¢¯æ™‚æ•¸","åˆè¨ˆæ™‚æ•¸","èª¿ç”¨æ•™å®˜äººæ•¸","æ˜¯å¦æä¾›è·¨ç¸£å¸‚","å‚™è¨»"], 
                            ...d2.map((r,i)=>[i+1,r.m,r.unit,r.name,r.target,r.date,(r.excludeList||[]).join(','),r.loc,r.batch,r.pBatch,(r.batch*r.pBatch)||0,r.dHour,r.bHour,(r.batch*r.bHour)||0,r.inst,r.ext?'æ˜¯':'å¦',r.note])];
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(d2_out), "é™„ä»¶2");
            // Data 3
            const d3_out = [["åºè™Ÿ","æ‰¿è¾¦å–®ä½","é‡å¤§æ´»å‹•åç¨±","åƒåŠ å°è±¡","æ—¥æœŸ","æ’é™¤æ—¥æœŸ","å¤©æ•¸","æ™‚æ•¸","æ¯æ—¥èª¿ç”¨å¤–å‹¤äººæ•¸","åœ°é»"], 
                            ...d3.map((r,i)=>[i+1,r.unit,r.name,r.target,r.date,(r.excludeList||[]).join(','),r.days,r.hours,r.mp,r.loc])];
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(d3_out), "é™„ä»¶3");
            
            // Gantt Data (çœç•¥è©³ç´°è¨ˆç®—ï¼ŒåŒ renderGantt é‚è¼¯)
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet([["èªªæ˜", "è«‹åƒè€ƒç¶²é ç”˜ç‰¹åœ–ï¼Œæˆ–æ–¼æ­¤è™•å¯¦ä½œè©³ç´°æ•¸æ“šåŒ¯å‡º"]]), "ç”˜ç‰¹åœ–æ•¸æ“š");

            XLSX.writeFile(wb, "114å¹´è¨“ç·´æµè·¯.xlsx");
        }

        // Helper
        function addRow(t){if(t==1)d1.push({excludeList:[]});if(t==2)d2.push({excludeList:[]});if(t==3)d3.push({excludeList:[]});renderAll();}
        function del(t,i){if(confirm('åˆªé™¤?')){if(t==1)d1.splice(i,1);if(t==2)d2.splice(i,1);if(t==3)d3.splice(i,1);renderAll();}}
        function renderAll(){renderT1();renderT2();renderT3();}
    </script>
</body>
</html>
